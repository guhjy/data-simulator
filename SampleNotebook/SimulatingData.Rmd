---
title: "Example Notebook:  Creating Simulated Data"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
    css: custom.css
    highlight: zenburn
    theme: lumen
    df_print: paged
---

## Data Simulation

It is sometimes necessary to create simulated data when it is impractical to obtain real data.   The functions in this simulation suite allow a user to:

*  Create a compendium of variables to simulate based on the desired statistical properties
*  Simulate and validate data
*  Organize simulated data by nodes in a data model and export to json for easy upload.

### Environment Prep

```{r}
source('SimData.R')
source('ValidateFunction.R')
source('SimtoJson.R')
```

## Create a Compendium

In order to simulate a dataset, a compendium must be filled out.   The fields are as follows:

* __DESCRIPTION__ describes the variable
* __NODE__ we use a graphing representation of data to build out a data commons.   A node represents where the simulated data will sit in a the data model.  
* __VARIABLE__ the name of the variable
* __REQUIRED__ boolean representing whether this will be a required value in the data model
* __TYPE__  options: enum, boolean, number, integer.   This field dictates the logic in the following fields.  
* __CHOICES__  If enum, this represents the enum options
* __PROBS__  If enum or boolean this represents the probabilites for each option.   If boolean, the first probability represents `TRUE`
* __DISTRIB__ If number or integer, this field represents the distribution that best represents the data. 
* __DISTRIB.INPUTS__  If number or integer, this field represents the distribution inputs (eg, mean, sd, lambda, etc)
* __NAS__ proportion of the variable that should be NA.

### Load Compendium

```{r}
compendium <- read.csv("SampleCompendium/sampleClinical.csv", header=T, stringsAsFactors = F)
```

### Review the Compendium

Below are the last 6 rows of the compendium we'll simulate later on.

```{r}
#knitr::kable(tail(compendium, 6), caption="Sample of the Compendium")
tail(compendium, 6)
```

## Simulation

Once a compendium is created, simulation relies on the functions in SimData.R and (optionally - see V2 below) the functions in ValidateFunction.R. 

### V1: Simulate Data w/o Rejecting

In the attempt below, we'll include the creation of NAs, but not reject any of the variables simmed.   We'll accept the first simulation run of each variable.

```{r}
n <- 1000 #simulate this many observations

SimulatedData <- simData(compendium, n, include.na = TRUE, reject=FALSE)

#write.csv(SimulatedData, "mySimData.csv") #data could easily output to csv
```

#### Plot Simmed Data

```{r}
threshold <- .05 #reject variables that fail test below this
variables <- compendium$VARIABLE

par(mfrow = c(2, 3))
for (i in variables) {
    validateVar(i, compendium, SimulatedData, threshold, include.plot=T)
}
```

### V2: Simulate Data Rejecting

We may want more QC to make sure our simulated variables match our projected distributions.    We can reject a simulation and resimulate it until it meets a declared threshold (p > x for the appropriate test).    

Below, we set a very high p-value and let it run until all simulated variables meet our threshold. 

__NOTE__ for a very low n (< 100), don't use the reject method.   The assigned statistical test is likely to fail.  

```{r}
SimulatedData2 <- simData(compendium, n, include.na = TRUE, 
                         reject=TRUE, threshold=.6) # set a very high threshold
#write.csv(SimulatedData2, "mySimData.csv")
```

#### Plot Simmed Data 

Here we'll see values > than the threshold set in the simulation call above. 

```{r}
par(mfrow = c(2, 3))
for (i in variables) {
    validateVar(i, compendium, SimulatedData2, include.plot=T)
}
```

## Create Json by Node

To easily add simulated entries into a data commons, use the function in SimtoJson.R.   Once satisfactory data is simulated, the SimtoJson function will group by nodes in the data model (a column in the compendium) and create json output for easy import.

```{r}
n <- 10
SimulatedData <- simData(compendium, n, 
                         include.na = TRUE, 
                         reject= FALSE)

SimtoJson(SimulatedData, compendium, 'JsonOutput/')
```

